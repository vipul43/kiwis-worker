name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    name: CI Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true

      - name: Download dependencies
        run: make deps

      - name: Check code formatting
        run: make fmt-check

      - name: Run linter
        run: make lint

      - name: Run tests
        run: make test

      - name: Build application
        run: make build

      - name: Upload coverage reports
        if: success()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  migrations:
    name: Test Migrations
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: kiwis_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true

      - name: Install golang-migrate
        run: make migrate-install

      - name: Create account table (simulates Prisma schema)
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/kiwis_test?sslmode=disable
        run: |
          psql "$DATABASE_URL" -c "
            CREATE TABLE account (
              id TEXT PRIMARY KEY,
              \"accountId\" TEXT NOT NULL,
              \"providerId\" TEXT NOT NULL,
              \"userId\" TEXT NOT NULL,
              \"accessToken\" TEXT,
              \"refreshToken\" TEXT,
              \"idToken\" TEXT,
              \"accessTokenExpiresAt\" TIMESTAMPTZ,
              \"refreshTokenExpiresAt\" TIMESTAMPTZ,
              scope TEXT,
              password TEXT,
              \"createdAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
              \"updatedAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW()
            );
          "

      - name: Run migrations (up)
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/kiwis_test?sslmode=disable
        run: make migrate-up

      - name: Verify tables exist
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/kiwis_test?sslmode=disable
        run: |
          psql "$DATABASE_URL" -c "\dt" | grep -E "account_sync_job|email_sync_job|llm_sync_job|payment"

      - name: Run migrations (down)
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/kiwis_test?sslmode=disable
        run: |
          # Run all down migrations to test rollback
          migrate -path migrations -database "$DATABASE_URL" down -all

      - name: Run migrations (up again)
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/kiwis_test?sslmode=disable
        run: make migrate-up
